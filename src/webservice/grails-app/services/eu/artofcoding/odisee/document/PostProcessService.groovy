/*
 * Odisee(R)
 * Copyright (C) 2005-2010 Informationssysteme Ralf Bensmann.
 * Copyright (C) 2011-2012 art of coding UG (haftungsbeschr√§nkt).
 *
 * Alle Rechte vorbehalten. Nutzung unterliegt Lizenzbedingungen.
 * All rights reserved. Use is subject to license terms.
 */
package eu.artofcoding.odisee.document

import eu.artofcoding.flux.grails.helper.FileHelper
import eu.artofcoding.odisee.image.ImageMagickCategory
import eu.artofcoding.odisee.image.ImageMagickService
import org.w3c.dom.Element
import groovy.xml.dom.DOMCategory

/**
 *
 */
class PostProcessService {

    /**
     *
     */
    static transactional = false

    /**
     * The image service.
    ImageMagickService imageMagickService
     */

    /**
     * The PDF service.
     */
    PdfService pdfService

    /**
     * <action type="merge-with">
     * @param arg
     * @param actionElement
     */
    void processMergeWith(Map arg, Element actionElement) {
        def request = null
        // What file was generated by this request?
        String generatedFile = arg.result.output[0]
        // Create new filename
        Map decomposedFilename = FileHelper.decomposeFilename(generatedFile)
        File destPdfFile = new File("${decomposedFilename.name}_merged.pdf")
        List<File> pdfFiles = []
        // Get order to merge PDF files from XML request
        use(DOMCategory) {
            request = arg.xml.request[arg.activeIndex]
            // Build ordered list with PDF files to merge
            actionElement.'*'.each {
                // <result-placeholder/>
                // Where to place the generated PDF file?
                if (it.name() == 'result-placeholder') {
                    pdfFiles << new File(generatedFile)
                } else {
                    String filename = null
                    // If path of file is relative, assume ODISEE_VAR
                    if (it.'@file'.toString()[0] != '/') {
                        filename = "${System.getenv('ODISEE_VAR')}/${it.'@file'}"
                    } else {
                        filename = it.'@file'.toString()
                    }
                    pdfFiles << new File(filename)
                }
            }
        }
        // Merge PDFs and generate a new one
        pdfService.mergeDocuments(destPdfFile, pdfFiles)
    }

}
